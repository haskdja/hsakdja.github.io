<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì»´íŒ¨ë‹ˆì–¸ - ê°€ìƒ ì¹œêµ¬ì™€ ì±„íŒ…</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ (style.css íŒŒì¼ì´ ì—†ì–´ë„ ë™ì‘í•˜ë„ë¡ ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€) */
        body { font-family: sans-serif; margin: 0; background-color: #f0f2f5; }
        .auth-overlay { display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .auth-modal { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        .auth-form h2 { text-align: center; }
        .form-container { display: flex; flex-direction: column; gap: 1rem; }
        .form-container input { padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; }
        .form-container button { padding: 0.8rem; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; }
        .error-message { color: red; text-align: center; margin-top: 0.5rem; min-height: 1.2em; }
        .main-container { display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */ }
        /* ì—¬ê¸°ì— ë” ë§ì€ CSSê°€ í•„ìš”í•˜ì§€ë§Œ, ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìµœì†Œ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. */
    </style>
</head>
<body>
    <div class="auth-overlay" id="auth-overlay" style="display: flex;">
        <div class="auth-modal">
            <div class="auth-form" id="login-form" style="display: block;">
                <h2>ğŸ¤– AI ì»´íŒ¨ë‹ˆì–¸ ë¡œê·¸ì¸</h2>
                <div class="form-container">
                    <input type="email" id="login-email" placeholder="ğŸ“§ ì´ë©”ì¼" required>
                    <input type="password" id="login-password" placeholder="ğŸ”’ ë¹„ë°€ë²ˆí˜¸" required>
                    <button type="button" id="login-btn">ë¡œê·¸ì¸</button>
                    <div class="error-message" id="login-error"></div>
                </div>
                <p>ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="show-register">íšŒì›ê°€ì…</a></p>
                <div class="demo-account">
                    <p><small>ğŸ“Œ ë°ëª¨ ê³„ì •: test@test.com / 1234</small></p>
                </div>
            </div>

            <div class="auth-form" id="register-form" style="display: none;">
                <h2>ğŸŒŸ AI ì»´íŒ¨ë‹ˆì–¸ íšŒì›ê°€ì…</h2>
                <div class="form-container">
                    <input type="text" id="register-nickname" placeholder="ğŸ‘¤ ë‹‰ë„¤ì„" required maxlength="10">
                    <input type="email" id="register-email" placeholder="ğŸ“§ ì´ë©”ì¼" required>
                    <input type="password" id="register-password" placeholder="ğŸ”’ ë¹„ë°€ë²ˆí˜¸" required minlength="4">
                    <input type="password" id="register-confirm" placeholder="ğŸ”’ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
                    <button type="button" id="register-btn">íšŒì›ê°€ì…</button>
                    <div class="error-message" id="register-error"></div>
                </div>
                <p>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="show-login">ë¡œê·¸ì¸</a></p>
            </div>
        </div>
    </div>

    <div class="main-container" id="main-container" style="display: none;">
        <div id="user-nickname"></div>
        <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
        <div id="character-name"></div>
        <div id="character-emoji"></div>
        <div id="character-status"></div>
        <div id="chat-messages"></div>
        <div id="typing-indicator" style="display: none;">
             <div class="message-avatar"></div>
        </div>
        <input type="text" id="message-input">
        <button id="send-button">ì „ì†¡</button>
        <button id="api-toggle"><span class="api-status"></span></button>
        <div id="api-status-text"></div>
        <div class="character-option" data-character="ani"></div>
        <div class="character-option" data-character="yuki"></div>
        <div class="character-option" data-character="kai"></div>
    </div>

    <script>
        console.log('Script loading...');
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentCharacter = 'ani';
        let useAPI = true;
        let conversationHistory = {};
        
        // Google AI API ì„¤ì •
        const GOOGLE_API_KEY = 'AIzaSyAOxpnkAq7nJhdR1FvIm_fkxE4jiSBmEsQ';
        const GOOGLE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

        // ìºë¦­í„° ì„¤ì •
        const characters = {
            ani: { name: 'Ani', emoji: 'ğŸ‘§', greeting: 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” Aniì˜ˆìš”~ ğŸŒ¸', systemPrompt: 'ë„ˆëŠ” Aniì•¼...', status: 'ì˜¨ë¼ì¸ â€¢ í™œë°œí•œ ì†Œë…€' },
            yuki: { name: 'Yuki', emoji: 'â„ï¸', greeting: 'ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” Yukiì…ë‹ˆë‹¤ â„ï¸', systemPrompt: 'ë„ˆëŠ” Yukiì•¼...', status: 'ì˜¨ë¼ì¸ â€¢ ì°¨ë¶„í•œ ì¹œêµ¬' },
            kai: { name: 'Kai', emoji: 'ğŸ¤–', greeting: 'ì•ˆë…•í•˜ì„¸ìš”! Kaiì…ë‹ˆë‹¤ ğŸ¤–', systemPrompt: 'ë„ˆëŠ” Kaiì•¼...', status: 'ì˜¨ë¼ì¸ â€¢ ë˜‘ë˜‘í•œ ì¡°ìˆ˜' }
        };

        // DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            try {
                initializeApp();
                bindEvents();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        function initializeApp() {
            const savedUser = localStorage.getItem('ai_companion_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    localStorage.removeItem('ai_companion_user');
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
            loadConversationHistory();
        }

        function bindEvents() {
            console.log('Binding events...');
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-password').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('register-confirm').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
            
            // ì•„ë˜ ìš”ì†Œë“¤ì€ ë©”ì¸ í™”ë©´ì— ì‹¤ì œë¡œ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const sendButton = document.getElementById('send-button');
            if(sendButton) sendButton.addEventListener('click', sendMessage);

            const messageInput = document.getElementById('message-input');
            if(messageInput) messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            const apiToggle = document.getElementById('api-toggle');
            if(apiToggle) apiToggle.addEventListener('click', toggleAPI);

            document.querySelectorAll('.character-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const character = e.target.getAttribute('data-character');
                    if (character) switchCharacter(character);
                });
            });
            console.log('All events bound successfully');
        }

        function showAuthModal() {
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            if (currentUser) {
                const userNicknameEl = document.getElementById('user-nickname');
                if(userNicknameEl) userNicknameEl.textContent = currentUser.nickname;
            }
            // initializeChat(); // ì±„íŒ… ê´€ë ¨ UIê°€ ì™„ì „í•  ë•Œ ì£¼ì„ í•´ì œ
        }

        function showRegisterForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            clearErrors();
            document.getElementById('register-nickname').focus();
        }

        function showLoginForm() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            clearErrors();
            document.getElementById('login-email').focus();
        }
        
        function clearErrors() {
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-error').textContent = '';
        }

        function handleRegister() {
            const nickname = document.getElementById('register-nickname').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;

            if (!nickname || !email || !password || !confirmPassword) {
                showError('register', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (password !== confirmPassword) {
                showError('register', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            if (password.length < 4) {
                showError('register', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError('register', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            const existingUsers = JSON.parse(localStorage.getItem('ai_companion_users') || '[]');
            if (existingUsers.some(user => user.email === email)) {
                showError('register', 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                nickname: nickname,
                email: email,
                password: hashPassword(password),
                createdAt: new Date().toISOString()
            };

            existingUsers.push(newUser);
            localStorage.setItem('ai_companion_users', JSON.stringify(existingUsers));

            currentUser = newUser;
            localStorage.setItem('ai_companion_user', JSON.stringify(currentUser));
            showSuccess('register', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            setTimeout(showMainApp, 1500);
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showError('login', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const existingUsers = JSON.parse(localStorage.getItem('ai_companion_users') || '[]');
            const user = existingUsers.find(u => u.email === email && u.password === hashPassword(password));

            if (!user) {
                showError('login', 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            currentUser = user;
            localStorage.setItem('ai_companion_user', JSON.stringify(currentUser));
            showSuccess('login', 'ë¡œê·¸ì¸ ì„±ê³µ!');
            setTimeout(showMainApp, 1000);
        }

        function handleLogout() {
            const oldUser = currentUser;
            currentUser = null;
            localStorage.removeItem('ai_companion_user');
            conversationHistory = {};
            
            const chatMessages = document.getElementById('chat-messages');
            if(chatMessages) chatMessages.innerHTML = '';
            
            showAuthModal();
        }

        function showError(type, message) {
            const el = document.getElementById(`${type}-error`);
            if (el) {
                el.textContent = message;
                el.style.color = '#ff4757';
            }
        }

        function showSuccess(type, message) {
            const el = document.getElementById(type === 'login' ? 'login-error' : 'register-error');
             if (el) {
                el.textContent = message;
                el.style.color = '#2ed573';
            }
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // ì±„íŒ… ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤ì€ ì—¬ê¸°ì— ìœ„ì¹˜í•©ë‹ˆë‹¤. (ìƒëµ)
        function loadConversationHistory() { /* ... */ }
        function sendMessage() { /* ... */ }
        function switchCharacter(characterKey) { /* ... */ }
        function toggleAPI() { /* ... */ }
        
        console.log('AI Companion script fully loaded');
    </script>
</body>
</html>
