<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 컴패니언 - 가상 친구와 채팅</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    <style>
        /* 기본 스타일 (style.css 파일이 없어도 동작하도록 간단한 스타일 추가) */
        body { font-family: sans-serif; margin: 0; background-color: #f0f2f5; }
        .auth-overlay { display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .auth-modal { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        .auth-form h2 { text-align: center; }
        .form-container { display: flex; flex-direction: column; gap: 1rem; }
        .form-container input { padding: 0.8rem; border: 1px solid #ccc; border-radius: 4px; }
        .form-container button { padding: 0.8rem; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; }
        .error-message { color: red; text-align: center; margin-top: 0.5rem; min-height: 1.2em; }
        .main-container { display: none; /* 기본 숨김 */ }
        /* 여기에 더 많은 CSS가 필요하지만, 기능 테스트를 위한 최소 스타일입니다. */
    </style>
</head>
<body>
    <div class="auth-overlay" id="auth-overlay" style="display: flex;">
        <div class="auth-modal">
            <div class="auth-form" id="login-form" style="display: block;">
                <h2>🤖 AI 컴패니언 로그인</h2>
                <div class="form-container">
                    <input type="email" id="login-email" placeholder="📧 이메일" required>
                    <input type="password" id="login-password" placeholder="🔒 비밀번호" required>
                    <button type="button" id="login-btn">로그인</button>
                    <div class="error-message" id="login-error"></div>
                </div>
                <p>계정이 없으신가요? <a href="#" id="show-register">회원가입</a></p>
                <div class="demo-account">
                    <p><small>📌 데모 계정: test@test.com / 1234</small></p>
                </div>
            </div>

            <div class="auth-form" id="register-form" style="display: none;">
                <h2>🌟 AI 컴패니언 회원가입</h2>
                <div class="form-container">
                    <input type="text" id="register-nickname" placeholder="👤 닉네임" required maxlength="10">
                    <input type="email" id="register-email" placeholder="📧 이메일" required>
                    <input type="password" id="register-password" placeholder="🔒 비밀번호" required minlength="4">
                    <input type="password" id="register-confirm" placeholder="🔒 비밀번호 확인" required>
                    <button type="button" id="register-btn">회원가입</button>
                    <div class="error-message" id="register-error"></div>
                </div>
                <p>이미 계정이 있으신가요? <a href="#" id="show-login">로그인</a></p>
            </div>
        </div>
    </div>

    <div class="main-container" id="main-container" style="display: none;">
        <div id="user-nickname"></div>
        <button id="logout-btn">로그아웃</button>
        <div id="character-name"></div>
        <div id="character-emoji"></div>
        <div id="character-status"></div>
        <div id="chat-messages"></div>
        <div id="typing-indicator" style="display: none;">
             <div class="message-avatar"></div>
        </div>
        <input type="text" id="message-input">
        <button id="send-button">전송</button>
        <button id="api-toggle"><span class="api-status"></span></button>
        <div id="api-status-text"></div>
        <div class="character-option" data-character="ani"></div>
        <div class="character-option" data-character="yuki"></div>
        <div class="character-option" data-character="kai"></div>
    </div>

    <script>
        console.log('Script loading...');
        
        // 전역 변수
        let currentUser = null;
        let currentCharacter = 'ani';
        let useAPI = true;
        let conversationHistory = {};
        
        // Google AI API 설정
        const GOOGLE_API_KEY = 'AIzaSyAOxpnkAq7nJhdR1FvIm_fkxE4jiSBmEsQ';
        const GOOGLE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

        // 캐릭터 설정
        const characters = {
            ani: { name: 'Ani', emoji: '👧', greeting: '안녕하세요! 저는 Ani예요~ 🌸', systemPrompt: '너는 Ani야...', status: '온라인 • 활발한 소녀' },
            yuki: { name: 'Yuki', emoji: '❄️', greeting: '안녕하세요. 저는 Yuki입니다 ❄️', systemPrompt: '너는 Yuki야...', status: '온라인 • 차분한 친구' },
            kai: { name: 'Kai', emoji: '🤖', greeting: '안녕하세요! Kai입니다 🤖', systemPrompt: '너는 Kai야...', status: '온라인 • 똑똑한 조수' }
        };

        // DOM 로드 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            try {
                initializeApp();
                bindEvents();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        function initializeApp() {
            const savedUser = localStorage.getItem('ai_companion_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    localStorage.removeItem('ai_companion_user');
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
            loadConversationHistory();
        }

        function bindEvents() {
            console.log('Binding events...');
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showRegisterForm(); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showLoginForm(); });
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-password').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('register-confirm').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleRegister(); });
            
            // 아래 요소들은 메인 화면에 실제로 존재해야 합니다.
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            const sendButton = document.getElementById('send-button');
            if(sendButton) sendButton.addEventListener('click', sendMessage);

            const messageInput = document.getElementById('message-input');
            if(messageInput) messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            const apiToggle = document.getElementById('api-toggle');
            if(apiToggle) apiToggle.addEventListener('click', toggleAPI);

            document.querySelectorAll('.character-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const character = e.target.getAttribute('data-character');
                    if (character) switchCharacter(character);
                });
            });
            console.log('All events bound successfully');
        }

        function showAuthModal() {
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            if (currentUser) {
                const userNicknameEl = document.getElementById('user-nickname');
                if(userNicknameEl) userNicknameEl.textContent = currentUser.nickname;
            }
            // initializeChat(); // 채팅 관련 UI가 완전할 때 주석 해제
        }

        function showRegisterForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
            clearErrors();
            document.getElementById('register-nickname').focus();
        }

        function showLoginForm() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            clearErrors();
            document.getElementById('login-email').focus();
        }
        
        function clearErrors() {
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-error').textContent = '';
        }

        function handleRegister() {
            const nickname = document.getElementById('register-nickname').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;

            if (!nickname || !email || !password || !confirmPassword) {
                showError('register', '모든 필드를 입력해주세요.');
                return;
            }
            if (password !== confirmPassword) {
                showError('register', '비밀번호가 일치하지 않습니다.');
                return;
            }
            if (password.length < 4) {
                showError('register', '비밀번호는 4자 이상이어야 합니다.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError('register', '올바른 이메일 형식이 아닙니다.');
                return;
            }

            const existingUsers = JSON.parse(localStorage.getItem('ai_companion_users') || '[]');
            if (existingUsers.some(user => user.email === email)) {
                showError('register', '이미 가입된 이메일입니다.');
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                nickname: nickname,
                email: email,
                password: hashPassword(password),
                createdAt: new Date().toISOString()
            };

            existingUsers.push(newUser);
            localStorage.setItem('ai_companion_users', JSON.stringify(existingUsers));

            currentUser = newUser;
            localStorage.setItem('ai_companion_user', JSON.stringify(currentUser));
            showSuccess('register', '회원가입이 완료되었습니다!');
            setTimeout(showMainApp, 1500);
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showError('login', '이메일과 비밀번호를 입력해주세요.');
                return;
            }

            const existingUsers = JSON.parse(localStorage.getItem('ai_companion_users') || '[]');
            const user = existingUsers.find(u => u.email === email && u.password === hashPassword(password));

            if (!user) {
                showError('login', '이메일 또는 비밀번호가 잘못되었습니다.');
                return;
            }

            currentUser = user;
            localStorage.setItem('ai_companion_user', JSON.stringify(currentUser));
            showSuccess('login', '로그인 성공!');
            setTimeout(showMainApp, 1000);
        }

        function handleLogout() {
            const oldUser = currentUser;
            currentUser = null;
            localStorage.removeItem('ai_companion_user');
            conversationHistory = {};
            
            const chatMessages = document.getElementById('chat-messages');
            if(chatMessages) chatMessages.innerHTML = '';
            
            showAuthModal();
        }

        function showError(type, message) {
            const el = document.getElementById(`${type}-error`);
            if (el) {
                el.textContent = message;
                el.style.color = '#ff4757';
            }
        }

        function showSuccess(type, message) {
            const el = document.getElementById(type === 'login' ? 'login-error' : 'register-error');
             if (el) {
                el.textContent = message;
                el.style.color = '#2ed573';
            }
        }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // 채팅 및 기타 함수들은 여기에 위치합니다. (생략)
        function loadConversationHistory() { /* ... */ }
        function sendMessage() { /* ... */ }
        function switchCharacter(characterKey) { /* ... */ }
        function toggleAPI() { /* ... */ }
        
        console.log('AI Companion script fully loaded');
    </script>
</body>
</html>
